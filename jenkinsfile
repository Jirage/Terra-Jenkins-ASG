pipeline {
  agent any

  environment {
    AWS_REGION   = 'us-east-1'
    TF_DIR       = 'terraform'
    TF_WORKSPACE = 'prod'
    PATH         = "/usr/local/bin:/usr/bin:/bin"
  }

  stages {

    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Prepare') {
      steps {
        sh "mkdir -p terraform/userdata"
        sh "echo 'Deployed from commit ${GIT_COMMIT}' > terraform/userdata/version.txt"
      }
    }

    stage('Terraform Init & Plan') {
      steps {
        dir("${TF_DIR}") {
          sh "terraform version"
          sh "ls -l /usr/local/bin/"
          sh "which terraform"
          sh "terraform init -input=false -reconfigure"
          sh "terraform workspace select ${TF_WORKSPACE} || terraform workspace new ${TF_WORKSPACE}"
          sh "terraform plan -out=tfplan -input=false"
        }
      }
    }

    stage('Terraform Apply') {
      steps {
        dir("${TF_DIR}") {
          sh "terraform apply -input=false -auto-approve tfplan"
        }
      }
    }

    stage('Trigger Instance Refresh') {
      steps {
        sh """
          aws autoscaling start-instance-refresh \
            --auto-scaling-group-name \$(terraform -chdir=${TF_DIR} output -raw asg_name) \
            --preferences '{\"MinHealthyPercentage\":80}' || true
        """
      }
    }

    stage('Validate Deployment') {
      steps {
        script {
          def alb = sh(script: "cd ${TF_DIR} && terraform output -raw alb_dns_name", 
                       returnStdout: true).trim()
          sh "curl -f http://${alb} || true"
        }
      }
    }
  }
}
