pipeline {
  agent any

  environment {
    AWS_REGION    = 'us-east-1'
    TF_DIR        = 'terraform'
    TF_WORKSPACE  = 'prod'
  }

  stages {

    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Prepare') {
      steps {
        // Update version file with commit hash
        sh '''
          echo "Deployed from ${GIT_COMMIT}" > terraform/userdata/version.txt
        '''
      }
    }

    stage('Terraform Init/Plan') {
      steps {
        dir("${TF_DIR}") {
          sh '''
            terraform init -input=false -reconfigure
            terraform workspace select prod || terraform workspace new prod
            terraform plan -out=tfplan -input=false
          '''
        }
      }
    }

    stage('Terraform Apply') {
      steps {
        dir("${TF_DIR}") {
          sh '''
            terraform apply -input=false -auto-approve tfplan
          '''
        }
      }
    }

    stage('Trigger Instance Refresh') {
      steps {
        // Use single quotes to avoid Groovy parsing of $()
        sh '''
          ASG_NAME=$(terraform -chdir=terraform output -raw asg_name)
          aws autoscaling start-instance-refresh \
            --auto-scaling-group-name "$ASG_NAME" \
            --preferences '{"MinHealthyPercentage":80}' || true
        '''
      }
    }

    stage('Validate') {
      steps {
        script {
          def alb = sh(
            script: "cd ${TF_DIR} && terraform output -raw alb_dns_name",
            returnStdout: true
          ).trim()

          sh """
            curl -f http://${alb} || true
          """
        }
      }
    }

  }
}
