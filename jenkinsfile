pipeline {
  agent any

  environment {
    AWS_REGION   = 'us-east-1'
    TF_DIR       = 'terraform'
    TF_WORKSPACE = 'prod'
  }

  stages {

    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Prepare') {
      steps {
        sh '''
          # Create userdata directory if missing
          mkdir -p ${TF_DIR}/userdata

          # Save deployed version info
          echo "Deployed from commit ${GIT_COMMIT}" > ${TF_DIR}/userdata/version.txt
        '''
      }
    }

    stage('Terraform Init & Plan') {
      steps {
        dir("${TF_DIR}") {
          sh '''
            terraform init -input=false -reconfigure
            terraform workspace select ${TF_WORKSPACE} || terraform workspace new ${TF_WORKSPACE}
            terraform plan -out=tfplan -input=false
          '''
        }
      }
    }

    stage('Terraform Apply') {
      steps {
        dir("${TF_DIR}") {
          sh "terraform apply -input=false -auto-approve tfplan"
        }
      }
    }

    stage('Trigger Instance Refresh') {
      steps {
        dir("${TF_DIR}") {
          sh '''
            ASG_NAME=$(terraform output -raw asg_name)
            
            if [ -n "$ASG_NAME" ]; then
              echo "Starting instance refresh for $ASG_NAME"
              aws autoscaling start-instance-refresh \
                --auto-scaling-group-name "$ASG_NAME" \
                --preferences '{"MinHealthyPercentage":80}'
            else
              echo "ASG name not found via terraform output"
            fi
          '''
        }
      }
    }

    stage('Validate Deployment') {
      steps {
        script {
          def alb = sh(script: "cd ${TF_DIR} && terraform output -raw alb_dns_name", returnStdout: true).trim()
          sh "curl -f http://${alb} || true"
        }
      }
    }
  }
}
